<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html
class=" js flexbox canvas canvastext webgl no-touch geolocation postmessage no-websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients no-cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths"
lang="en">
	<!--<![endif]-->
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>SensorAct</title>
		<link rel="stylesheet" type="text/css"
		href="@{'/public/stylesheets/styles_non_centered.css'}">
		<link rel="stylesheet" type="text/css"
		href="@{'/public/stylesheets/style.css'}">
		<script src="@{'/public/js/libs/modernizr-2.0.6.min.js'}"></script>
		<link rel="stylesheet" type="text/css"
		href="@{'/public/stylesheets/jquery-ui-1.8.21.custom.css'}">
		<script src="@{'/public/javascripts/jquery-1.6.4.min.js'}"
		type="text/javascript" charset="${_response_encoding}"></script>
		<script src="@{'/public/javascripts/jquery-ui-1.8.20.custom.min.js'}"
		type="text/javascript" charset="${_response_encoding}"></script>
		<script src="@{'/public/javascripts/constants.js'}"
		type="text/javascript" charset="${_response_encoding}"></script>
		<script type="text/javascript" src="@{'/public/javascripts/utilityFunctions.js'}"></script>
		<script type="text/javascript">

			$(document).ready(function() {

				/**
				 * Global Variables used during the lifecycle of the page
				 *
				 */
				var deviceToEdit = $("#devicename").val();
				//alert(deviceToEdit);
				var isDevice = $("#isdevice").val();
				var mode = $("#mode").val();
				
					/*
				 * Adding the link attribute to Logout,Home element
				 */
			/********************* --------------- Changes made here --------------- ***************/
				setNavURL("#devices" ,'href', URL_DEVICES);
				setNavURL("#visualization",'href', URL_VISUALIZATION);
				setNavURL("#repositoryInformation",'href',URL_REPOSITORY_INFO);
				setNavURL("#home",'href',URL_HOME);
				setNavURL("#logout",'href',URL_LOGOUT_USER);

				//alert(isDevice);
				var deleteDeviceOrTemplate;
				var findDeviceOrTemplate;
				if(isDevice == "true") {
					deleteDeviceOrTemplate = URL_DELETE_DEVICE;
					findDeviceOrTemplate = URL_FIND_DEVICE;
					console.log(findDeviceOrTemplate);
				} else {
					deleteDeviceOrTemplate = URL_DELETE_DEVICE_TEMPLATE;
					findDeviceOrTemplate = URL_FIND_DEVICE_TEMPLATE;

				}

				var newSensorCount = 0;
				var newActuatorCount = 0;
				var secretkey = FAKE_SECRET_KEY;
				var errorState = false;
				var errorInformation = "";
				var receivedData = {};
				var deviceObject = {};
				var newNumberOfSensors = 0;
				var newNumberOfActuators = 0;

				var value = 0;
				/*counter for dynamic attribute allocation focus*/

				var classReference = "";
				/*  */
				/*
				 * Setting the AJAX to work in sycnhronous fashion
				 */
				jQuery.ajaxSetup({
					async : false
				});

				/*
				 * Adding the link attribute to Logout,Home element
				 */
				//$("#logout").attr('href', URL_LOGOUT_USER);
				//$("#home").attr('href', URL_HOME);
				//alert("here i am - - begin");
				/*
				 * Hiding Error Divs
				 */
				$("#errorDiv").hide();
				$("#getDeviceErrorDiv").hide();


function createCustomElement(elementType,parent,id,Class,content,style)
					{
						
						var $_element=$(document.createElement(elementType));
						

						$_element.attr(
						{
							"class":Class,
							"id":id
						});
						
						$_element.css(
							style	
						);

						if(elementType=="input")
						{
							$_element.val(content);
						}
						else
						{
							$_element.append(content);
						}
						
						parent.append($_element);
						return $_element;
						

					}


					function makeErrorTr(parent)
					{
													var err = createCustomElement("tr",parent,null,"errortr","",null);
													createCustomElement("td",err,null,null,"",null);

													createCustomElement("td",err,null,"labName","","{'font-size':'12px','width':'120px'}");
													createCustomElement("td",err,null,null,"",null);
													createCustomElement("td",err,null,"labUnit","","{'font-size':'12px','width':'120px'}");
													createCustomElement("td",err,null,null,"",null);
													createCustomElement("td",err,null,"labType","","{'font-size':'12px','width':'120px'}");
													createCustomElement("td",err,null,null,"",null);
													createCustomElement("td",err,null,"labSampling","","{'font-size':'12px','width':'120px'}");
													}

					function makeDataTr(parent,name,unit,type,samplingperiod)
													{
														//param = content;
													var p = createCustomElement("tr",parent,null,"datatr","",{'text-align':'center'});
													//alert("bye");
													var q = createCustomElement("td",p,null,null,"",{'width':'12px'});
													createCustomElement("label",q,null,null,"Name",null);
													var q = createCustomElement("td",p,null,null,"",null);			
													createCustomElement("input",q,null,"labName",name,null);
													var q = createCustomElement("td",p,null,null,"",null);
													createCustomElement("label",q,null,null,"Unit",null);
													var q = createCustomElement("td",p,null,null,"",null);			
													createCustomElement("input",q,null,"labUnit",unit,null);
													var q = createCustomElement("td",p,null,null,"",null);
													createCustomElement("label",q,null,null,"Type",null);
													var q = createCustomElement("td",p,null,null,"",null);			
													createCustomElement("input",q,null,"labType",type,null);
													var q = createCustomElement("td",p,null,null,"",null);
													createCustomElement("label",q,null,null,"Sampling Period",{'width':'145px'});
													var q = createCustomElement("td",p,null,null,"",null);			
													createCustomElement("input",q,null,"labSampling",samplingperiod,null);
													document.createTextNode('\u00a0');
														//alert("hello");
													document.createTextNode('\u00a0');
													var q = createCustomElement("td",p,null,null,"",null);
													createCustomElement("span",q,null,null,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",null);			
													createCustomElement("button",q,null,"google-button-blue removeChannel","Remove",null);

												}


				function makeIPDiv(parent,deviceIP){
									
									var p = createCustomElement("div",parent,"ipDiv",null,"",null);
									var q = createCustomElement("label",p,null,null,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Device IP",{'width':'130px'});
									createCustomElement("input",p,"newDeviceIP",null,deviceIP,null);
									createCustomElement("span",p,null,null,"",null);
				}		


				function makeActDiv(parent,actName){

					var p = createCustomElement("div",parent,"newActuator",null,"",null);
									createCustomElement("p",p,null,"actuatorDivPara","Actuator Details",null);
									createCustomElement("hr",p,null,null,"",null);
									//alert("between");

									var q = createCustomElement("label",p,null,null,"Actuator Name ",{'width':'110px'});
									createCustomElement("input",p,null,"labActName",actName,null);
									createCustomElement("span",p,null,null,"",null);
									createCustomElement("br",p,null,null,"",null);
																		createCustomElement("br",p,null,null,"",null);

									createCustomElement("button",p,null,"google-button-blue removeActuator","Remove Actuator",null);
									createCustomElement("hr",p,null,null,"",null);
				}	



						function makeSensorDiv(parent,sensorName,sensorID){
									createCustomElement("p",parent,null,"space","",null);
									var p = createCustomElement("div",parent,null,"sensorDiv","",null);
									createCustomElement("p",p,null,"sensorDivPara","Sensor Details",null);
									createCustomElement("hr",p,null,null,"",null);
									//alert("between");

									var q = createCustomElement("label",p,null,null,"Sensor Name",{'width':'110px'});
									createCustomElement("input",p,"newSensorName","newSensor",sensorName,null);
									createCustomElement("span",p,null,null,"",null);

									createCustomElement("br",p,null,null,"",null);
																		



									
									
									var q = createCustomElement("label",p,null,null,"Sensor ID",{'width':'110px'});
									createCustomElement("input",p,"newSensorID","newSensorID",sensorID,null);
									createCustomElement("span",p,null,null,"",null);

									createCustomElement("br",p,null,null,"",null);
									createCustomElement("br",p,null,null,"",null);

									createCustomElement("button",p,null,"google-button-blue newSensorAddChannel","Add channels",null);

									createCustomElement("span",p,null,null,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",null);
									createCustomElement("button",p,null,"google-button-blue newSensorRemove","Delete Sensor",null);
									createCustomElement("p",p,null,"space","",null);
									createCustomElement("div",p,null,"newSensorChannels","",null);

									createCustomElement("hr",p,null,null,"",null);		
}

				/**
				 * @param :Error Information
				 * This function appends the passed string to the AddDeviceErrorDiv and shows the relevant error container
				 * Now only in use for catch elements of unexpected errors
				 */

				function alertAddDeviceError(errorInformation) {

					$("#errorDiv").html(errorInformation);
					$("#errorDiv").fadeIn('slow');
					return false;
				}

				/**
				 * @param :Error Information
				 * This function appends the passed string to the GetDeviceErrorDiv and shows the relevant error container
				 */
				function alertGetDeviceError(errorInformation) {
					$("#getDeviceErrorDiv").html(errorInformation);
					$("#getDeviceErrorDiv").fadeIn('slow');
					return false;
				}
/**************************--------------------Changes Made Here---------------------*************************/
				/**
				*	@Param:Object Reference:  JQuery Object Reference to the object under test
				*	This function will set the error td with the particular parameter
				*/
				function classReferenceError(objectReference,classReference){
										$(objectReference).parent().parent().next().children('td.'+classReference.substring(0,classReference.indexOf(" ",0))).text(errorInformation);
				}
/*************************---------------------Changes Made Here----------------------***********************/
				/**
				 * @param:
				 * 1.Object Reference(object)  :JQuery Object Reference to the object under test
				 * 2.Minimum Length (int)   :Minimum Length of the attribute
				 * 3.Maximum Length (int)   :Maximum Length of the attribute
				 * 4.ErrorField    (string) :
				 * The name of the attribute
				 * 5.ErrorFieldAttribute1(string) :The name of the first relevant attribute
				 * 6.ErrorFieldAttribute2(string) :The name of the second relevant attribute
				 *
				 * An example call would be like (this,2,20,"sensor","name",sensorCount=2)
				 * If the validation fails it shall append "Enter name of 2th sensor within 2 and 20 characters"
				 *
				 * This function can also be called like
				 * (this,2,20,"device","name","") for attributes like device where the last attribute may not be required
				 * In case validation fails an error like "Enter name of device within 2 and 20 characters" shall be appended
				 *
				 * In either case the error is appended to the error div and the corresponding faulty elements are highlighted
				 */

				function validateFieldAndMakeErrorInformation(objectReference, minimumLength, maximumLength, errorField, errorFieldAttribute1, errorFieldAttribute2) {
					//alert(errorFieldAttribute2);
					if((($(objectReference).val().length) < minimumLength ) || (($(objectReference).val().length) > maximumLength )) {

						//$(objectReference).addClass("error");
						//value++;

						//assigning the count attribute value to all possible error fields for focus
						//$(objectReference).attr('count', value);
						//errorState = true;
						/*changed here*/

						//errorInformation = "";
						/********************* --------------- Changes made here --------------- ***************/

						$(objectReference).addClass("error");
						value++;

						//assigning the count attribute value to all possible error fields for focus
						$(objectReference).attr('count', value);
						errorState = true;
						

						errorInformation = "";

						


						/********************* --------------- Changes made here --------------- ***************/


						if(errorFieldAttribute2.length > 0) {
							errorInformation = errorInformation + " Enter " + errorFieldAttribute1 + " of " + errorFieldAttribute2 + " th " + errorField + " within " + minimumLength + " and " + maximumLength + "characters";

							//alert(errorFieldAttribute2.length.toString() + "length of sensorCount");

							// checking if errors related to channel fields or not and accordingly displaying them in span or td.
							if(!($(objectReference).parent().parent().parent().attr('class') == "newSensorChannels")) {
								//alert('not channel');
								$(objectReference).next().text(errorInformation);
							} else {
								classReference = $(objectReference).attr('class');
								//if this works, then would have to add all three .

								/*---------------------Changes Made here----------------------------*/
								
								
								classReferenceError(objectReference,classReference);
								/*
								if(classReference == "labName error") {
									$('input[class="labName error"]').parent().parent().next().children('td.labName').text(errorInformation);
								}
								if(classReference == "labUnit error") {
									$('input[class="labUnit error"]').parent().parent().next().children('td.labUnit').text(errorInformation);
								}
								if(classReference == "labType error") {
									$('input[class="labType error"]').parent().parent().next().children('td.labType').text(errorInformation);
								}
								*/
								/*---------------------Changes Made here----------------------------*/
							}
						} else {
							//errorInformation = errorInformation + " Enter " + errorFieldAttribute1 + " of " + errorField + " within " + minimumLength + " and " + maximumLength + " characters";
							alert("in validate else block");
							errorInformation = errorInformation + " Enter within " + minimumLength + " and " + maximumLength + " characters ";
							if(!($(objectReference).parent().parent().parent().attr('class') == "newSensorChannels")) {
								$(objectReference).next().text(errorInformation);

							} else {
								classReference = $(objectReference).attr('class');


		/**************----------------------Changes Made Here---------------------****************/
								classReferenceError(objectReference,classReference);
								/*

								if(classReference == "labName error") {
									$('input[class="labName error"]').parent().parent().next().children('td.labName').text(errorInformation);
								}
								if(classReference == "labUnit error") {
									$('input[class="labUnit error"]').parent().parent().next().children('td.labUnit').text(errorInformation);
								}
								if(classReference == "labType error") {
									$('input[class="labType error"]').parent().parent().next().children('td.labType').text(errorInformation);
								}
								*/
		/**************----------------------Changes Made Here---------------------****************/
							}
						}
					} else {
						$(objectReference).removeClass("error");
					}
				}

				function validateNumericFieldValue(objectReference, minimumValue, maximumValue, errorField, errorFieldAttribute1, errorFieldAttribute2) {
					var temp;
					temp = parseInt($(objectReference).val());

					if(isNaN(temp)) {

						//$(objectReference).addClass("error");
						//errorState = true;
						//value++;
						//$(objectReference).attr('count', value);
						//errorInformation = "";

						/********************* --------------- Changes made here --------------- ***************/

						$(objectReference).addClass("error");
						value++;

						//assigning the count attribute value to all possible error fields for focus
						$(objectReference).attr('count', value);
						errorState = true;
						

						errorInformation = "";

						


						/********************* --------------- Changes made here --------------- ***************/

						//errorInformation = errorInformation + " " + errorFieldAttribute1 + " of " + errorFieldAttribute2 + " th " + errorField + " must be an integer";
						errorInformation = errorInformation + " " + errorFieldAttribute1 + " of " + errorField + " must be an integer";
						//differentiating between channel fields errors and others
						if(!($(objectReference).parent().parent().parent().attr('class') == "newSensorChannels")) {

							$(objectReference).next().text(errorInformation);
						} else {
							classReference = $(objectReference).attr('class');
							if(classReference == "labSampling error") {
								errorInformation = "It must be an integer";
					/**************----------------------Changes Made Here---------------------****************/
								//$('input[class="labSampling error"]').parent().parent().next().children('td.labSampling').text(errorInformation);
								classReferenceError(objectReference,classReference);
					/**************----------------------Changes Made Here---------------------****************/
							}

						}
					} else {
						if(temp < minimumValue || temp > maximumValue) {
							//$(objectReference).addClass("error");
							//errorState = true;
							//value++;
							//$(objectReference).attr('count', value);
							//errorInformation = "";
							/********************* --------------- Changes made here --------------- ***************/

						$(objectReference).addClass("error");
						value++;

						//assigning the count attribute value to all possible error fields for focus
						$(objectReference).attr('count', value);
						errorState = true;
						

						errorInformation = "";

						


						/********************* --------------- Changes made here --------------- ***************/

							errorInformation = errorInformation + " Enter " + errorFieldAttribute1 + " of " + errorFieldAttribute2 + " th " + errorField + "'s value within " + minimumValue + " and " + maximumValue;
							//differentiating between channel fields errors and others
							if(!($(objectReference).parent().parent().parent().attr('class') == "newSensorChannels")) {

								$(objectReference).next().text(errorInformation);
							} else {
								classReference = $(objectReference).attr('class');

								if(classReference == "labSampling error") {
									errorInformation = " Enter within " + minimumValue + " and " + maximumValue + " characters ";
			/**************----------------------Changes Made Here---------------------****************/
									
							classReferenceError(objectReference,classReference);

									//$('input[class="labSampling error"]').parent().parent().next().children('td.labSampling').text(errorInformation);


								}

							}
						} else {
							$(objectReference).removeClass("error");
						}
					}

				}

				var editDevice = {};
				editDevice["devicename"] = deviceToEdit;
				editDevice[SECRET_KEY] = secretkey;

				/*
				 * Make a query to fetch the device
				 */
				if(deviceToEdit != FAKE_DEVICE_NAME) {

					try {
						//alert("here i am meee");
						$.post(findDeviceOrTemplate, JSON.stringify(editDevice), function(data) {
							receivedData = data;
							//alert(JSON.stringify(receivedData));

							//Successfully received data
							if(receivedData.hasOwnProperty(RESPONSE_STATUS_CODE))//Means a failure has occured {
							//The API call has failed
							{
								alertGetDeviceError("Following errors occured " + receivedData[RESPONSE_MESSAGE]);
							} else {
								//Got the device profile
								//Add highest level information
								$("#newDeviceName").val(receivedData[DEVICE_NAME]);
								$("#newDeviceLocation").val(receivedData[DEVICE_LOCATION]);
								$("#newDeviceTags").val(receivedData[DEVICE_TAGS]);

								//Add actuators
								if(receivedData.hasOwnProperty(DEVICE_ACTUATORS)) {
									var parent = $('#newActuatorsDiv');
									//alert("1");
									/*$("#newActuatorsDiv").append("<div id=ipDiv><label style='width:130px;' id=\"newDeviceIPLabel\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Device IP</label><input id=newDeviceIP value=" + receivedData[DEVICE_IP] + "></input><span></span></div>");
*/									var deviceIP = receivedData[DEVICE_IP];
									//alert("2");
									makeIPDiv(parent,deviceIP);
									//alert("3");
									
									/*$("#newActuatorsDiv").append("<div id=ipDiv><label style='width:130px;' id=\"newDeviceIPLabel\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Device IP</label><input id=newDeviceIP value=" + receivedData[DEVICE_IP] + "></input><span></span></div>");
									*/
									var actuatorsArray = receivedData[DEVICE_ACTUATORS];
									for(var i = 0; i < actuatorsArray.length; i++) {
										
										var parent = $('#newActuatorsDiv');
											//alert(parent);
									/*$("#newActuatorsDiv").append("<div id=ipDiv><label style='width:130px;' id=\"newDeviceIPLabel\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Device IP</label><input id=newDeviceIP value=" + receivedData[DEVICE_IP] + "></input><span></span></div>");
*/									var actName = actuatorsArray[i][DEVICE_ACTUATOR_NAME];
									//alert(JSON.stringify(actName));
									
										makeActDiv(parent,actName);
																		//alert("between234");
									

										newNumberOfActuators++;
										$(".removeActuator").unbind('click').click(function() {

											$(this).parent().remove();
											newNumberOfActuators--;
											if(newNumberOfActuators == 0) {
												$('#ipDiv').remove();
											}
										});
									}
								}
								if(receivedData.hasOwnProperty(DEVICE_SENSORS)) {
									var sensorsArray = receivedData[DEVICE_SENSORS];
									//alert(JSON.stringify(sensorsArray));
									for(var i = 0; i < sensorsArray.length; i++) {
										var parent  = $("#newSensorsDiv");														
										
									
									var sensorName = sensorsArray[i][DEVICE_SENSOR_NAME];
									var sensorID = sensorsArray[i][DEVICE_SENSOR_ID];

									makeSensorDiv(parent,sensorName,sensorID);

										//alert(sensorsArray[i]["name"]);
										/*
										$("#newSensorsDiv").append("<p class='space'></p><div class='sensorDiv'><p class='sensorDivPara'>Sensor Details</p><hr/><label style='width:110px;'>Sensor Name</label><input id='newSensorName' class='newSensor' value=" + sensorsArray[i][DEVICE_SENSOR_NAME] + "></input><span></span><br/><label style='width:110px;'>Sensor ID</label><input id='newSensorID' class='newSensorID' value=" + sensorsArray[i][DEVICE_SENSOR_ID] + "></input><span></span><br/><br/>" + "<button class='google-button-blue newSensorAddChannel'>Add channels</button>" + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button class='google-button-blue newSensorRemove'>Delete Sensor</button>" + "<p class='space'></p><div class='newSensorChannels'></div><hr/></div>");*/

										$(".newSensorRemove").click(function() {

											$(this).parent().remove();
											newNumberOfSensors--;
											return false;
										});
										var channelsArray = sensorsArray[i][DEVICE_SENSOR_CHANNELS];
										var ctr = 0;

										$("#newSensorsDiv").find(".sensorDiv").each(function() {
											if(ctr == i) {
												for(var j = 0; j < channelsArray.length; j++) {
													var parent = $(this).children(".newSensorChannels");
													alert("previous ");
													var name = channelsArray[j]["name"];
													var unit = channelsArray[j]["unit"];
													var type = channelsArray[j]["type"];
													var samplingperiod = channelsArray[j]["samplingperiod"];
													makeDataTr(parent,name,unit,type,samplingperiod);

												
													makeErrorTr(parent);
													

													/*
													($(this).children(".newSensorChannels")).append("<tr style='text-align:center;' class='datatr'><td width='12px'><label>Name</label></td><td><input class='labName' value=" + channelsArray[j]["name"] + "></input></td><td><label>Unit</label></td><td><input class='labUnit' value=" + channelsArray[j]["unit"] + "></input><td><label>Type</label></td><td><input class='labType' value=" + channelsArray[j]["type"] + "></input></td><td><label style='width:145px'>Sampling Period</label></td><td><input class='labSampling'value=" + channelsArray[j]["samplingperiod"] + "></input>&nbsp;&nbsp;<td><button class='google-button-blue removeChannel'>Remove</button></td></tr><tr class='errortr'><td></td><td class='labName' style='font-size:12px;width:10px'></td><td></td><td class='labUnit' style='font-size:12px;width:120px'></td><td></td><td class='labType' style='font-size:12px;width:120px'></td><td></td><td class='labSampling' style='font-size:12px;width:120px'></td></tr>");
													*/
													$(".removeChannel").click(function() {
														$(this).parent().parent().next().remove();
														$(this).parent().parent().remove();

													});
												}
											}
											ctr++;
										});

										$('.newSensorAddChannel').unbind('click').click(function() {
										
										//($(this).siblings(".newSensorChannels")).children('#noSensorChannelsError').text("");
																				($(this).siblings(".newSensorChannels")).children().remove();

										var parent = $(this).siblings(".newSensorChannels");
											alert("click");
										
											makeDataTr(parent,"","","","");
												makeErrorTr(parent);
										/*
											($(this).siblings(".newSensorChannels")).append("<tr class='datatr' ><td><label>Name</label></td><td><input class='labName'/></td><td><label>Unit</label></td><td><input class='labUnit'/><td><label>Type</label></td><td><input class='labType'/></td><td><label style='width:145px'>Sampling Period</label></td><td><input class='labSampling'/>&nbsp;&nbsp;<td><button class='google-button-blue removeChannel'>Remove</button></td></tr><tr class='errortr'><td></td><td class='labName' style='font-size:12px;width:120px'></td><td></td><td class='labUnit' style='font-size:12px;width:120px'></td><td></td><td class='labType' style='font-size:12px;width:120px'></td><td></td><td class='labSampling' style='font-size:12px;width:120px'></td></tr>");
											*/
											$(".removeChannel").click(function() {
												$(this).parent().parent().next().remove();
												$(this).parent().parent().remove();

											});
											return false;
										});
										newNumberOfSensors++;
									}

								}

							}

						});
					} catch(e) {
						//alert("here i am");
						alertGetDeviceError(e);
					}
				}

				/*
				 * Description:This function is used to add a new sensor
				 */

				$("#addNewSensor").click(function() {
									$("#noSensorNoActuator").html("");
					var parent  = $("#newSensorsDiv");
					makeSensorDiv(parent,"","");
					/*
					$("#newSensorsDiv").append("<p class='space'></p><div class='sensorDiv'><p class='sensorDivPara'>Sensor Details</p><hr/><label style='width:110px;'>Sensor Name</label><input id='newSensorName' class='newSensor'></input><span></span><br/><label style='width:110px;'>Sensor ID</label><input id='newSensorID' class='newSensorID'></input><span></span><br/><br/>" + "<button class='google-button-blue newSensorAddChannel'>Add channels</button>" + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button class='google-button-blue newSensorRemove'>Delete Sensor</button>" + "<p class='space'></p><div class='newSensorChannels'></div><hr/></div>");
					*/
					$(".newSensorRemove").click(function() {

						$(this).parent().remove();
						newNumberOfSensors--;
						return false;
					});
					$('.newSensorAddChannel').unbind('click').click(function() {

												($(this).siblings(".newSensorChannels")).children('#noSensorChannelsError').text("");
						
						var parent = $(this).siblings(".newSensorChannels");
						makeDataTr(parent);
						makeErrorTr(parent,"","","","");
						alert("creating");
						/*($(this).siblings(".newSensorChannels")).append("<tr class='datatr'><td><label>Name</label></td><td><input class='labName'/></td><td><label>Unit</label></td><td><input class='labUnit'/><td><label>Type</label></td><td><input class='labType'/></td><td><label style='width:145px'>Sampling Period</label></td><td><input class='labSampling'/><td>&nbsp;&nbsp;<button class='google-button-blue removeChannel'>Remove</button></td></tr><tr class='errortr'><td></td><td class='labName' style='font-size:12px;width:120px'></td><td></td><td class='labUnit' style='font-size:12px;width:120px'></td><td></td><td class='labType' style='font-size:12px;width:120px'></td><td></td><td class='labSampling' style='font-size:12px;width:120px'></td></tr>");
						*/
						$(".removeChannel").click(function() {
							$(this).parent().parent().next().remove();
							$(this).parent().parent().remove();

						});
						return false;
					});
					newNumberOfSensors++;
					return false;
				});
				/*
				 * Description:Function to add a new Actuator
				 * This function is called when the button corresponding to add new actuator is clicked
				 * It would create new DIV and place in it the new Actuator within a HTML label
				 * It also binds a function to remove the actuator
				 */

				$("#addNewActuator").unbind('click').click(function() {
				
					newNumberOfActuators++;
					$("#noSensorNoActuator").html("");

					if(newNumberOfActuators == 1) {
						/*
						$("#newActuatorsDiv").append("<div id=ipDiv><label style='width:130px;' id=\"newDeviceIPLabel\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Device IP</label><input type=\"text\" id=\"newDeviceIP\"></input><span></span></div>");*/
						//$("#newActuatorsDiv").addClass("border");
						var parent = $("#newActuatorsDiv");
						makeIPDiv(parent,"");
						//$("#newActuatorsDiv").css('border':'2px solid');
					}
					/*if(newNumberOfActuators == 0) {
					 $("#newActuatorsDiv").css('border':'0px');
					 }*/
					 var parent = $('#newActuatorsDiv');
					 makeActDiv(parent,"");
					/*$("#newActuatorsDiv").append("<div id='newActuator'><p class='actuatorDivPara'>Actuator Details</p><hr/><label style='width:110px;'>Actuator Name </label><input class=labActName></input><span></span><br/><br/><button class='google-button-blue removeActuator'>Remove Actuator</button><hr/></div>");*/

					$(".removeActuator").unbind('click').click(function() {
						$(this).parent().remove();
						newNumberOfActuators--;
						if(newNumberOfActuators == 0) {
							$('#ipDiv').remove();
							$("#newActuatorsDiv").removeClass("border");

						}
					});
					return false;
				});
				/*
				 * This function is invoked when Done Device is clicked.
				 * It does a validation for all the fields present in the device
				 */
				$("#doneDevice").click(function() {
					errorState = false;
					channel = false;
					errorInformation = "";
					deviceObject[DEVICE_ACTUATORS] = new Array();
					deviceObject[DEVICE_SENSORS] = new Array();
					$('input[count!="0"]').attr('count', '0');
					var actuatorCount = 0;
					var sensorCount = 0;
					value = 0;
					

					//for errors removal
					$('input[count="0"]').next().text("");
					
					$('tr[class="errortr"]').children('td').text("");
				
					$('#noSensorNoActuator').html("");
					$('#noSensorChannelsError').html("");
			
					deviceObject[DEVICE_NAME] = $("#newDeviceName").val();
					validateFieldAndMakeErrorInformation($("#newDeviceName"), MIN_LENGTH_DEVICE_NAME, MAX_LENGTH_DEVICE_NAME, "device", "name", "");
					deviceObject[DEVICE_LOCATION] = $("#newDeviceLocation").val();
					validateFieldAndMakeErrorInformation($("#newDeviceLocation"), MIN_LENGTH_DEVICE_LOCATION, MAX_LENGTH_DEVICE_LOCATION, "device", "location", "");

					deviceObject[DEVICE_TAGS] = $("#newDeviceTags").val();
					validateFieldAndMakeErrorInformation($("#newDeviceTags"), MIN_LENGTH_DEVICE_TAGS, MAX_LENGTH_DEVICE_TAGS, "device", "tags", "");
			
					//Adding sensors
					$("#newSensorsDiv").find("input.newSensor").each(function() {

						deviceObject[DEVICE_SENSORS][sensorCount] = {};
						if($(this).attr('id') == "newSensorName") {
							deviceObject[DEVICE_SENSORS][sensorCount][DEVICE_SENSOR_NAME] = $(this).val();

							validateFieldAndMakeErrorInformation(this, MIN_LENGTH_SENSOR_NAME, MAX_LENGTH_SENSOR_NAME, "sensor", "name", sensorCount);
							deviceObject[DEVICE_SENSORS][sensorCount][DEVICE_SENSOR_ID] = $(this).siblings(".newSensorID").val();
							//validateFieldAndMakeErrorInformation($(this).siblings(".newSensorID"), MIN_LENGTH_SENSOR_ID, MAX_LENGTH_SENSOR_ID, "sensor", "id", sensorCount);
							validateNumericFieldValue($(this).siblings(".newSensorID"), MIN_VALUE_SENSOR_ID, MAX_VALUE_SENSOR_ID, "sensor", "ID", sensorCount);
						}
						
						deviceObject[DEVICE_SENSORS][sensorCount][DEVICE_SENSOR_CHANNELS] = new Array();
						//Now attaching it's channels to it
						var newChannelCount = 0;
						$(this).parent().children(".newSensorChannels").find("tr.datatr").each(function() {
							deviceObject[DEVICE_SENSORS][sensorCount][DEVICE_SENSOR_CHANNELS][newChannelCount] = {};
							$(this).find('td').each(function() {
								$(this).find('input').each(function() {

									if(($(this).attr("class")).toString().indexOf(CLASS_DEVICE_SENSOR_CHANNEL_TYPE) >= 0) {
										deviceObject[DEVICE_SENSORS][sensorCount][DEVICE_SENSOR_CHANNELS][newChannelCount][DEVICE_SENSOR_CHANNEL_TYPE] = $(this).val();
										validateFieldAndMakeErrorInformation(this, MIN_LENGTH_CHANNEL_TYPE, MAX_LENGTH_CHANNEL_TYPE, "sensor's " + newChannelCount.toString() + " th channel", "type", sensorCount);
										

									}
						
									if(($(this).attr("class")).toString().indexOf(CLASS_DEVICE_SENSOR_CHANNEL_SAMPLING_PERIOD) >= 0) {
										deviceObject[DEVICE_SENSORS][sensorCount][DEVICE_SENSOR_CHANNELS][newChannelCount][DEVICE_SENSOR_CHANNEL_SAMPLING_PERIOD] = $(this).val();
										//validateFieldAndMakeErrorInformation(this, MIN_LENGTH_CHANNEL_SAMPLING_PERIOD, MAX_LENGTH_CHANNEL_SAMPLING_PERIOD, "sensor's " + newChannelCount.toString() + " th channel", "sampling period", sensorCount);
										alert("before validate");
										validateNumericFieldValue(this, MIN_VALUE_CHANNEL_SAMPLING_PERIOD, MAX_VALUE_CHANNEL_SAMPLING_PERIOD, "sensor's " + newChannelCount.toString() + " th channel", "sampling period", sensorCount);
									alert("after validate");

									}
								
									if(($(this).attr("class")).toString().indexOf(CLASS_DEVICE_SENSOR_CHANNEL_UNIT) >= 0) {
										deviceObject[DEVICE_SENSORS][sensorCount][DEVICE_SENSOR_CHANNELS][newChannelCount][DEVICE_SENSOR_CHANNEL_UNIT] = $(this).val();
										validateFieldAndMakeErrorInformation(this, MIN_LENGTH_CHANNEL_UNIT, MAX_LENGTH_CHANNEL_UNIT, "sensor's " + newChannelCount.toString() + " th channel", "unit", sensorCount);
										
									}

									if(($(this).attr("class")).toString().indexOf(CLASS_DEVICE_SENSOR_CHANNEL_NAME) >= 0) {

										deviceObject[DEVICE_SENSORS][sensorCount][DEVICE_SENSOR_CHANNELS][newChannelCount][DEVICE_SENSOR_CHANNEL_NAME] = $(this).val();
										validateFieldAndMakeErrorInformation(this, MIN_LENGTH_CHANNEL_NAME, MAX_LENGTH_CHANNEL_NAME, "sensor's " + newChannelCount.toString() + " th channel", "name", sensorCount);
							

									}
								});
							});
							newChannelCount++;
						

						});
						if(newChannelCount == 0)//Did not add any channel for this sensor
						{
						
							errorState = true;
							errorInformation = " Enter channel for sensor";
							channel = true;
				/***********************--------------------Changes Made Here-----------------------********************/
						$(this).parent().children('.newSensorChannels').html("<span id='noSensorChannelsError' style='color:red'>" + errorInformation + "</span>");
				/***********************--------------------Changes Made Here-----------------------********************/
							
						}
						sensorCount++;

					});

					//Adding Actuators
					$("#newActuatorsDiv").find("input.labActName").each(function() {

						deviceObject[DEVICE_ACTUATORS][actuatorCount] = {};
						deviceObject[DEVICE_ACTUATORS][actuatorCount][DEVICE_ACTUATOR_NAME] = $(this).val();
						validateFieldAndMakeErrorInformation(this, MIN_LENGTH_ACTUATOR_NAME, MAX_LENGTH_ACTUATOR_NAME, "actuator", "name", actuatorCount);
						actuatorCount++;
					});
					//Adding device information
					//Adding fake info for LAT/LON
					deviceObject[DEVICE_LATITUDE] = "1";
					deviceObject[DEVICE_LONGITUDE] = "1";

					if((sensorCount == 0) && (actuatorCount == 0)) {
						errorState = true;
						errorInformation = " Please add either a sensor or an actuator to the device";
						$('#newSensorsDiv').html("<span id='noSensorNoActuator' style='color:red'>" + errorInformation + "</span>");
						

					}
					if(actuatorCount == 0) {
						delete deviceObject["actuators"];
					}
					if(sensorCount == 0) {
						delete deviceObject["sensors"];
					}

					if(actuatorCount > 0) {
						deviceObject[DEVICE_IP] = $("#newDeviceIP").val();
						validateFieldAndMakeErrorInformation($("#newDeviceIP"), MIN_LENGTH_DEVICE_IP, MAX_LENGTH_DEVICE_IP, "device", "IP", "");
					}
					if(errorState == true) {
						//focus to first element
						$('input[count="1"]').focus();

						//for channel errors
						/*if(channel == true)
						 {
						 alertAddDeviceErrorChannel(errorInformation);
						 }
						 */
						return false;
					} else {
						$("#errorDiv").html("");
						$("#errorDiv").hide();
						$("#errorDiv1").html("");
						$("#errorDiv1").hide();
						//Hide error div
					}


					//Now the actual object to be sent to the broker is created,after all validation  has been done
					var deviceRequestToSend = {};
					deviceRequestToSend[DEVICE_PROFILE] = deviceObject;
					deviceRequestToSend[SECRET_KEY] = secretkey;
					var addDeviceOrTemplateURL;
					if($("#deviceOrTemplateSelect").find(":selected").text() == "Device") {
						addDeviceOrTemplateURL = URL_ADD_DEVICE;
					} else {
						addDeviceOrTemplateURL = URL_ADD_DEVICE_TEMPLATE;
					}
			/**************----------------------Changes Made Here---------------------****************/	
				function postToDeleteDevice(){
					try {
									$.post(addDeviceOrTemplateURL, JSON.stringify(deviceRequestToSend), function(data) {
										if(data[RESPONSE_STATUS_CODE] == 0) {
											window.location = URL_DEVICES;
										} else {
											alertAddDeviceError("Following error occured: " + data[RESPONSE_MESSAGE]);
										}

									});
								} catch(e) {
									alertAddDeviceError(e);
								}
				}
			/**************----------------------Changes Made Here---------------------****************/

					if(deviceToEdit != FAKE_DEVICE_NAME) {

						var messageToDeleteDevice = {};
						messageToDeleteDevice["devicename"] = deviceToEdit;
						messageToDeleteDevice[SECRET_KEY] = secretkey;



						//Delete older device
						if(mode == "update") {
							var isDeleteSuccessful = false;

							try {
								$.post(deleteDeviceOrTemplate, JSON.stringify(messageToDeleteDevice), function(data) {

									if(data[RESPONSE_STATUS_CODE] == SUCCESS) {
										isDeleteSuccessful = true;
									} else {
										alertGetDeviceError(data[RESPONSE_MESSAGE]);
									}

								});
							} catch(e) {
								alertAddDeviceError(e);
							}
							if(isDeleteSuccessful) {

/**************----------------------Changes Made Here---------------------****************/
								postToDeleteDevice();
/**************----------------------Changes Made Here---------------------****************/								
							}
						} else {
						/**************----------------------Changes Made Here---------------------****************/
							postToDeleteDevice();
							/*try {
								$.post(addDeviceOrTemplateURL, JSON.stringify(deviceRequestToSend), function(data) {
									if(data[RESPONSE_STATUS_CODE] == 0) {
										window.location = URL_DEVICES;
									} else {
										alertAddDeviceError("Following error occured: " + data[RESPONSE_MESSAGE]);
									}

								});
							} catch(e) {
								alertAddDeviceError(e);
							}*/
						/**************----------------------Changes Made Here---------------------****************/
						}
					}//
					else {
						//Device/Template was added from scratch
						/**************----------------------Changes Made Here---------------------****************/
						postToDeleteDevice();
						/*try {
							$.post(addDeviceOrTemplateURL, JSON.stringify(deviceRequestToSend), function(data) {
								if(data[RESPONSE_STATUS_CODE] == 0) {
									window.location = URL_DEVICES;
								} else {
									alertAddDeviceError("Following error occured: " + data[RESPONSE_MESSAGE]);
								}

							});
						} catch(e) {
							alertAddDeviceError(e);
						}*/
						/**************----------------------Changes Made Here---------------------****************/
					}//End else

					return false;

				});
			});

		</script>
	</head>
	<body>
		<div id="header-container">
			<header class="wrapper clearfix">
				<h1 id="title"> SensorAct
				<br>
				<br>
				<span style="font-size: 25px;">Sense - Interact - Actuate</span></h1>
				<!--<nav>

				<ul>
				<li><a id="home">Home</a></li>

				<li><a id="logout">Logout</a></li>
				</ul>

				</nav>-->
				<nav>
					<ul>
						<li>
							<a id="devices" class="active">Devices</a>
						</li>
						<li>
							<a id="visualization">Visualization</a>
						</li>
						<li>
							<a id="repositoryInformation">Repository Info</a>
						</li>
						<!--<li>
						<a id="logout">Logout</a>
						</li>-->
					</ul>
				</nav>
				<br />
				<br />
				<nav>
					<p class="pbox" style="margin-bottom:-20px;">
						Welcome ${username} &nbsp | &nbsp<span id="logout">Logout</span>
					</p>
				</nav>
			</header>
		</div>
		<div class="wrapper" style="width: 90%;">
			<div id="modeDiv">
				<h1 class="newfont" style="text-align: center">Edit
				Device/Template</h1>
			</div>
			<hr>
			<div style="display: none;" id="getDeviceErrorDiv" class="errorDiv"></div>
			<div style="display: none;" id="errorDiv" class="errorDiv"></div>
			<div id="newDevice">
				<br>
				<label id="newDeviceNameLabel">Name </label>
				<input id="newDeviceName" type="text">
				<span style='color:red;'></span>
				<br>
				<label id="newDeviceLocationLabel">Location </label>
				<input id="newDeviceLocation" type="text">
				<span style='color:red;'></span>
				<br>
				<label id="newDeviceTagsLabel">Tags </label>
				<input id="newDeviceTags" type="text">
				<span style='color:red;'></span>
				<br>
				<!--  added this -->
				<p class="space"></p>
				<button class='google-button-blue'  id="addNewSensor">
					Add a sensor
				</button>
				<!--  added this -->
				&nbsp;&nbsp;&nbsp;
				<button class='google-button-blue'  id="addNewActuator">
					Add an actuator
				</button>
				<div id="newSensorsDiv"></div>
				<hr />
				<!--  changed something here -->
				<div id="newActuatorsDiv"></div>
				<button class='google-button-blue'  id="doneDevice">
					Device Done
				</button>
				<!--  added this -->
				&nbsp;&nbsp;&nbsp;
				<select id="deviceOrTemplateSelect">
					<option selected="selected" value="device">Device</option>
					<option value="template">Template</option>
				</select>
			</div>
			<input id="devicename"  type="hidden" value=${devicename}>
			<input id="isdevice"  type="hidden" value=${isdevice}>
			<input	id="mode"  type="hidden" value=${mode}>
			<!-- changed here -->
			<!-- hr -->
		</div>
		<hr>
		<div style="clear: both;" id="footer-container">
			<footer class="wrapper">
				<h4 align="center">Â©2012 |MUC,IIIT-Delhi</h4>
			</footer>
		</div>
	</body>
</html>